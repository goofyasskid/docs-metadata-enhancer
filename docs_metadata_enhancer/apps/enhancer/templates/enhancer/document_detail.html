{% extends "base.html" %}
{% load static %}

{% block content %}

<div class="container-fluid">
    <div class="row">
        <!-- Первая колонка - Навигация и информация -->
        <div class="col-md-2 bg-light p-3">
            <div class="d-flex flex-column gap-2">
                <a href="{% if document.folder %}{% url 'enhancer:folder_detail' document.folder.id %}{% else %}{% url 'enhancer:file_system' %}{% endif %}"
                   class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left"></i> Назад
                </a>

                <div class="card">
                    <div class="card-header">
                        Информация о документе
                    </div>
                    <div class="card-body">
                        <p><strong>Название:</strong> {{ document.name }}</p>
                        <p><strong>Тип:</strong> {{ document.file_type }}</p>
                        <p><strong>Размер:</strong> {{ file_size }} МБ</p>
                        <p><strong>Папка:</strong> {% if document.folder %}{{ document.folder.name }}{% else %}Корневая{% endif %}</p>
                        <p><strong>Дата создания:</strong> {{ document.created_at|date:"d.m.Y H:i" }}</p>
                        <p><strong>Дата обновления:</strong> {{ document.updated_at|date:"d.m.Y H:i" }}</p>
                        {% if document.content %}
                        <div class="mt-3">
                            <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#contentCollapse">
                                <i class="bi bi-file-text"></i> Показать содержимое
                            </button>
                            <div class="collapse mt-2" id="contentCollapse">
                                <div class="card card-body bg-light">
                                    <pre class="mb-0" style="white-space: pre-wrap; font-size: 0.9em;">{{ document.content }}</pre>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                    </div>
                </div>
                <!-- Добавляем кнопку экспорта -->
                <div class="flex-column gap-2">
                    <button type="button" class="btn btn-success w-100" id="exportDocumentBtn" data-document-id="{{ document.id }}">
                        <i class="bi bi-download"></i> Экспорт
                    </button>
                </div>
            </div>
        </div>

        <!-- Вторая колонка - Метаданные -->
        <div class="col-md-5 p-3">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Метаданные</h5>
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-primary active" id="formViewBtn">
                            <i class="bi bi-card-text"></i> Форма
                        </button>
                        <button type="button" class="btn btn-outline-primary" id="jsonViewBtn">
                            <i class="bi bi-code-square"></i> JSON
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Форма для редактирования метаданных -->
                    <div id="formView">
                        <form id="metadataForm" method="post" action="{% url 'enhancer:document_detail' document.id %}">
                            {% csrf_token %}
                            {% if messages %}
                            <div id="save-result">
                                {% for message in messages %}
                                <div class="alert alert-{{ message.tags }}">{{ message }}</div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            <div id="metadataFields">
                                {% for key, meta_obj in metadata_with_types.items %}
                                {% if key != 'csrfmiddlewaretoken' %}
                                <div class="mb-3 metadata-field">
                                    {% if meta_obj.type == 'array' %}
                                    <div class="metadata-array" data-field="{{ key }}">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label class="form-label mb-0"><strong>{{ key }}</strong></label>
                                            <div class="array-buttons-group">
                                                <button type="button" class="btn btn-sm btn-outline-secondary toggle-array"><i class="bi bi-chevron-down"></i></button>
                                                <button type="button" class="btn btn-sm btn-outline-danger remove-array" data-key="{{ key }}"><i class="bi bi-trash"></i></button>
                                            </div>
                                        </div>
                                        <div class="metadata-array-items">
                                            <div class="actual-items-list">
                                                {% for item_string in meta_obj.value %}
                                                    <div class="metadata-array-item mb-2 simple-item-container">
                                                        <div class="input-group">
                                                            <input type="text" class="form-control array-item-value" name="{{ key }}[]" value="{{ item_string }}" placeholder="Значение">
                                                            <button type="button" class="btn btn-outline-danger remove-array-item"><i class="bi bi-trash"></i></button>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                            <div class="array-item-controls mt-2">
                                                <button type="button" class="btn btn-outline-success btn-sm add-array-item" data-key="{{ key }}">
                                                    <i class="bi bi-plus"></i> Добавить элемент
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    {% elif meta_obj.type == 'object' %}
                                    <div class="metadata-object" data-field="{{key}}">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label class="form-label mb-0">{{ key }}</label>
                                            <div class="array-buttons-group">
                                                <button type="button" class="btn btn-sm btn-outline-secondary toggle-object"><i class="bi bi-chevron-down"></i></button>
                                                <button type="button" class="btn btn-sm btn-outline-danger remove-array" data-key="{{ key }}"><i class="bi bi-trash"></i></button>
                                            </div>
                                        </div>
                                        <div class="metadata-object-content">
                                            {% for subkey, subvalue in meta_obj.value.items %}
                                            <div class="metadata-object-item mb-2">
                                                {% if subvalue is mapping %}
                                                <div class="metadata-nested-object">
                                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                                        <label class="form-label mb-0"><strong>{{ subkey }}</strong></label>
                                                        <button type="button" class="btn btn-sm btn-outline-secondary toggle-nested"><i class="bi bi-chevron-down"></i></button>
                                                    </div>
                                                    <div class="metadata-nested-content">
                                                        {% for nested_key, nested_value in subvalue.items %}
                                                        <div class="input-group mb-2">
                                                            <span class="input-group-text">{{ nested_key }}</span>
                                                            <input type="text" class="form-control" name="{{ key }}[{{ subkey }}][{{ nested_key }}]" value="{{ nested_value }}" placeholder="Значение">
                                                        </div>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                                {% else %}
                                                <div class="input-group">
                                                    <span class="input-group-text">{{ subkey }}</span>
                                                    <input type="text" class="form-control" name="{{ key }}[{{ subkey }}]" value="{{ subvalue }}" placeholder="Значение">
                                                    <button type="button" class="btn btn-outline-danger remove-object-item"><i class="bi bi-trash"></i></button>
                                                </div>
                                                {% endif %}
                                            </div>
                                            {% endfor %}
                                        </div>
                                        <button type="button" class="btn btn-outline-success btn-sm add-object-item" data-key="{{ key }}">
                                            <i class="bi bi-plus"></i> Добавить элемент объекта
                                        </button>
                                    </div>
                                    {% else %}
                                    <!-- Простое поле -->
                                    <div class="input-group">
                                        <span class="input-group-text"><strong>{{ key }}</strong></span>
                                        <input type="text" class="form-control" name="{{ key }}" value="{{ meta_obj.value }}" placeholder="Значение">
                                        <button type="button" class="btn btn-outline-danger remove-field" data-key="{{ key }}"><i class="bi bi-trash"></i></button>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                            <div class="mt-3">
                                <button type="button" class="btn btn-outline-success" id="addField">
                                    <i class="bi bi-plus"></i> Добавить поле
                                </button>
                                <div class="dropdown-menu" id="fieldTypeMenu">
                                    <a class="dropdown-item" href="#" data-type="simple">Простое поле</a>
                                    <a class="dropdown-item" href="#" data-type="array">Массив</a>
                                </div>
                                <button type="submit" class="btn btn-primary ms-2">
                                    Сохранить
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- JSON представление -->
                    <div id="jsonView" style="display: none;">
                        <pre id="jsonEditor">{{ metadata|safe }}</pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- Третья колонка - Wikidata -->
        <div class="col-md-5 p-3">
            <div class="card mb-4" id="wikidata-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Wikidata</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-primary"
                            id="updateWikidataBtn" data-document-id="{{ document.id }}">
                            <i class="bi bi-arrow-repeat"></i> Обновить связи
                        </button>
                        <button class="btn btn-sm btn-outline-info ms-2"
                            id="refreshDescriptionsBtn" data-document-id="{{ document.id }}">
                            <i class="bi bi-info-circle"></i> Обновить описания
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <form id="wikidataSearchForm">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="wikidataSearchQuery"
                                           placeholder="Введите поисковый запрос">
                                    <button class="btn btn-primary" type="submit">
                                        <i class="bi bi-search"></i> Поиск
                                    </button>
                                </div>
                            </form>
                            
                            <!-- Добавляем селектор поля метаданных -->
                            <div class="card mt-2">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">Выберите поле метаданных для связывания</h6>
                                    <span id="selectedFieldIndicator" class="badge bg-success" style="display: none;">Поле выбрано</span>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label for="metadataFieldKey" class="form-label">Поле метаданных</label>
                                            <select class="form-select" id="metadataFieldKey">
                                                <option value="" selected>Поле</option>
                                                {% for key, meta_obj in metadata_with_types.items %}
                                                <option value="{{ key }}" data-type="{{ meta_obj.type }}">{{ key }}</option>
                                                {% endfor %}
                                            </select>
                                            <input type="hidden" id="metadataFieldCategory">
                                        </div>
                                        <div class="col-md-8" id="metadataValueContainer">
                                            <div id="simpleFieldValueContainer" style="display: none;">
                                                <label for="metadataFieldSimpleValue" class="form-label">Значение поля</label>
                                                <input type="text" class="form-control" id="metadataFieldSimpleValue" readonly>
                                            </div>
                                            <div id="arrayFieldValueContainer" style="display: none;">
                                                <label for="metadataFieldArrayValue" class="form-label">Выберите значение</label>
                                                <select class="form-select" id="metadataFieldArrayValue">
                                                    <option value="" selected>Сначала выберите поле массива</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="wikidataSearchResults" style="max-height: 215px; overflow-y: auto;" class="mt-3"></div>
                        </div>
                        <div class="col">
                            <div id="wikidata-entities-container" style="max-height: 400px; overflow-y: auto;">
                                {% include "enhancer/fragments/wikidata_entities.html" %}
                            </div>
                            <div id="entity-linking-indicator" class="text-center my-2" style="display: none;">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="mt-2 text-primary">Обновление связей с Wikidata...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card" id="wikidata-entity-details-card" style="display: none;">
                 <div class="card-header">
                    Подробная информация о сущности Wikidata
                </div>
                <div class="card-body" id="wikidata-entity-details">
                    <p class="text-muted">Выберите сущность из списка или результатов поиска для просмотра деталей.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Подключаем модальные окна -->
{% include "enhancer/includes/modals.html" %}
{% endblock %}

{% block extra_css %}
<style>
/* ... ваши существующие стили ... */
.metadata-field {
    margin-bottom: 10px;
}
.metadata-array, .metadata-object, .metadata-nested-object {
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 10px;
    margin-bottom: 10px;
    background-color: #f8f9fa;
}
.metadata-array-item, .metadata-object-item {
    margin-bottom: 5px;
}
.metadata-nested-object {
    margin-left: 15px;
    background-color: #f0f0f0;
}
.input-group-text {
    min-width: 80px; /* Можно настроить по необходимости */
    justify-content: flex-start;
}
#jsonEditor {
    min-height: 300px;
    background-color: #f8f9fa;
    border: 1px solid #ced4da;
    padding: 10px;
    border-radius: .25rem;
    white-space: pre-wrap; /* Изменено для переноса длинных строк */
    word-wrap: break-word; /* Для лучшего переноса */
    font-family: monospace;
    font-size: 0.875em; /* Немного уменьшил для компактности */
    line-height: 1.5;
    overflow: auto;
}
.dropdown-menu {
    display: none;
    min-width: 160px; /* Уменьшил немного */
    padding: 0.5rem 0;
    margin: 0;
    font-size: 0.9rem; /* Уменьшил немного */
    color: #212529;
    text-align: left;
    list-style: none;
    background-color: #fff;
    background-clip: padding-box;
    border: 1px solid rgba(0, 0, 0, 0.15);
    border-radius: 0.25rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.175);
    z-index: 1021; /* Выше чем стандартный z-index для navbar */
}
.dropdown-item {
    display: block;
    width: 100%;
    padding: 0.35rem 1rem; /* Немного изменил падинги */
    clear: both;
    font-weight: 400;
    color: #212529;
    text-align: inherit;
    white-space: nowrap;
    background-color: transparent;
    border: 0;
}
.dropdown-item:hover, .dropdown-item:focus {
    color: #1e2125;
    background-color: #e9ecef;
}
.metadata-array-items, .metadata-object-content, .metadata-nested-content {
    /* display: none; По умолчанию показываем, если нет класса .show */
}
.metadata-array-items.collapsed,
.metadata-object-content.collapsed,
.metadata-nested-content.collapsed {
    display: none;
}
.array-item-controls {
    /* Стили для контейнера кнопок добавления элементов массива */
}

/* Стили для кнопки отвязывания сущности */
.unlink-entity-btn {
    z-index: 10;
    cursor: pointer;
    margin-left: 10px;
}
.unlink-entity-btn:hover {
    background-color: #dc3545;
    color: white;
}

/* Стили для кнопки массового отвязывания сущностей */
.bulk-unlink-btn {
    z-index: 10;
    cursor: pointer;
    margin-left: 5px;
    transition: all 0.3s ease;
}
.bulk-unlink-btn:hover {
    background-color: #dc3545;
    color: white;
    transform: scale(1.05);
}

.list-group-item {
    transition: opacity 0.5s, height 0.5s, padding 0.5s, margin 0.5s;
}

/* Стили для ссылок на Wikidata */
.text-primary .bi-box-arrow-up-right {
    font-size: 0.8em;
    margin-left: 3px;
}
a[href^="https://www.wikidata.org"]:hover {
    text-decoration: underline;
}

/* Стили для вкладок сущностей */
#wikidata-tabs {
    border-bottom: 1px solid #dee2e6;
}
#wikidata-tabs .nav-link {
    margin-bottom: -1px;
    border: 1px solid transparent;
    border-top-left-radius: 0.25rem;
    border-top-right-radius: 0.25rem;
}
#wikidata-tabs .nav-link.active {
    color: #495057;
    background-color: #fff;
    border-color: #dee2e6 #dee2e6 #fff;
}

/* Стили для блока описания сущности */
.entity-description {
    background-color: #f8f9fa;
    padding: 0.5rem;
    border-radius: 0.25rem;
    border-left: 3px solid #0d6efd;
    margin: 0.5rem 0;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Функция для отображения оповещений
    function showAlert(message, type = 'success') {
        const alertsContainer = document.getElementById('wikidata-alerts') || createAlertsContainer();
        
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        alertsContainer.appendChild(alert);
        
        // Автоматически скрываем оповещение через 5 секунд
        setTimeout(() => {
            if (alert && alert.parentNode) {
                alert.classList.remove('show');
                setTimeout(() => {
                    if (alert && alert.parentNode) {
                        alert.parentNode.removeChild(alert);
                    }
                }, 150);
            }
        }, 5000);
        
        return alert;
    }

    // Функция для создания контейнера оповещений, если его нет
    function createAlertsContainer() {
        const container = document.createElement('div');
        container.id = 'wikidata-alerts';
        container.style.position = 'fixed';
        container.style.top = '20px';
        container.style.right = '20px';
        container.style.zIndex = '9999';
        container.style.maxWidth = '400px';
        document.body.appendChild(container);
        return container;
    }

    // Переключение между формами представления
    const formViewBtn = document.getElementById('formViewBtn');
    const jsonViewBtn = document.getElementById('jsonViewBtn');
    const formView = document.getElementById('formView');
    const jsonView = document.getElementById('jsonView');
    const jsonEditor = document.getElementById('jsonEditor');

    formViewBtn.addEventListener('click', function() {
        formView.style.display = 'block';
        jsonView.style.display = 'none';
        formViewBtn.classList.add('active');
        jsonViewBtn.classList.remove('active');
    });

    jsonViewBtn.addEventListener('click', function() {
        formView.style.display = 'none';
        jsonView.style.display = 'block';
        formViewBtn.classList.remove('active');
        jsonViewBtn.classList.add('active');
        // При показе JSON, можно попробовать обновить его содержимое из текущей формы (если нужно)
        // или просто показать то, что было загружено (`{{ metadata|safe }}`)
    });

    // Обработка сворачивания/разворачивания
    document.addEventListener('click', function(e) {
        const toggleButton = e.target.closest('.toggle-array, .toggle-object, .toggle-nested');
        if (toggleButton) {
            let itemsContainer;
            if (toggleButton.classList.contains('toggle-array')) {
                itemsContainer = toggleButton.closest('.metadata-array').querySelector('.metadata-array-items');
            } else if (toggleButton.classList.contains('toggle-object')) {
                itemsContainer = toggleButton.closest('.metadata-object').querySelector('.metadata-object-content');
            } else if (toggleButton.classList.contains('toggle-nested')) {
                itemsContainer = toggleButton.closest('.metadata-nested-object').querySelector('.metadata-nested-content');
            }

            if (itemsContainer) {
                itemsContainer.classList.toggle('collapsed');
                const icon = toggleButton.querySelector('i');
                icon.classList.toggle('bi-chevron-down');
                icon.classList.toggle('bi-chevron-up');
            }
        }
         // Обработка отображения свойств сущностей Wikidata (если есть)
        if (e.target.classList.contains('toggle-properties') || e.target.parentElement.classList.contains('toggle-properties')) {
            // ... (ваш код)
        }
    });

    // Добавление нового поля
    const addFieldBtn = document.getElementById('addField');
    const fieldTypeMenu = document.getElementById('fieldTypeMenu');

    if (addFieldBtn) {
        addFieldBtn.addEventListener('click', function(e) {
            fieldTypeMenu.style.display = 'block';
            fieldTypeMenu.style.position = 'absolute'; // Убедитесь, что родитель имеет position: relative или absolute
            fieldTypeMenu.style.left = e.target.offsetLeft + 'px';
            fieldTypeMenu.style.top = (e.target.offsetTop + e.target.offsetHeight) + 'px';
        });
    }


    document.addEventListener('click', function(e) { // Глобальный обработчик для закрытия меню
        if (fieldTypeMenu && !e.target.closest('#addField') && !e.target.closest('#fieldTypeMenu')) {
            fieldTypeMenu.style.display = 'none';
        }
        // Другие делегированные обработчики кликов можно добавить сюда, если они не пересекаются
    });

    if (fieldTypeMenu) {
        fieldTypeMenu.addEventListener('click', function(e) {
            e.preventDefault();
            const target = e.target.closest('.dropdown-item');
            if (!target) return;

            const type = target.dataset.type;
            fieldTypeMenu.style.display = 'none';

            switch(type) {
                case 'simple':
                    addSimpleField();
                    break;
                case 'array':
                    addArrayField();
                    break;
                // case 'object': addMetadataObjectField(); break; // Если будете добавлять объекты
            }
        });
    }


    function addSimpleField() {
        const fieldId = `new-simple-${Date.now()}`;
        const field = document.createElement('div');
        field.className = 'mb-3 metadata-field new-simple-field-container'; // Класс для идентификации нового простого поля
        field.dataset.fieldId = fieldId;
        field.innerHTML = `
            <div class="input-group">
                <input type="text" class="form-control new-field-key" placeholder="Ключ">
                <input type="text" class="form-control new-field-value" placeholder="Значение">
                <button type="button" class="btn btn-outline-danger remove-field">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;
        document.getElementById('metadataFields').appendChild(field);
        field.querySelector('.new-field-key').focus();
    }

    function addArrayField() {
        const arrayId = `new-array-${Date.now()}`;
        const field = document.createElement('div');
        field.className = 'mb-3 metadata-field new-array-container'; // Класс для идентификации нового массива
        field.dataset.arrayId = arrayId;
        field.innerHTML = `
            <div class="metadata-array" data-field=""> <!-- data-field будет установлен из инпута ключа -->
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <input type="text" class="form-control new-array-key-input" placeholder="Ключ массива">
                    <div class="array-buttons-group">
                        <button type="button" class="btn btn-sm btn-outline-secondary toggle-array"><i class="bi bi-chevron-down"></i></button>
                        <button type="button" class="btn btn-sm btn-outline-danger remove-array"><i class="bi bi-trash"></i></button>
                    </div>
                </div>
                <div class="metadata-array-items">
                    <div class="actual-items-list"></div>
                    <div class="array-item-controls mt-2">
                        <button type="button" class="btn btn-outline-success btn-sm add-array-item">
                            <i class="bi bi-plus"></i> Добавить элемент
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('metadataFields').appendChild(field);
        const keyInput = field.querySelector('.new-array-key-input');
        keyInput.focus();
        // Обновляем data-key на кнопке удаления массива, когда ключ введен
        keyInput.addEventListener('change', function() {
            field.querySelector('.remove-array').dataset.key = this.value;
            field.querySelector('.metadata-array').dataset.field = this.value;
        });

    }

    // Глобальный обработчик кликов для динамически добавляемых элементов
    document.getElementById('metadataFields').addEventListener('click', function(e) {
        const addArrayItemButton = e.target.closest('.add-array-item');
        const removeFieldButton = e.target.closest('.remove-field, .remove-array-item, .remove-object-item, .remove-array');

        if (addArrayItemButton) {
            const arrayContainer = addArrayItemButton.closest('.metadata-array');
            const actualItemsList = arrayContainer.querySelector('.actual-items-list');
            let key = arrayContainer.dataset.field;

            if (arrayContainer.parentElement.classList.contains('new-array-container')) { // Это новый массив
                const keyInput = arrayContainer.querySelector('.new-array-key-input');
                key = keyInput.value.trim();
                if (!key) {
                    alert('Пожалуйста, введите ключ для нового массива.');
                    keyInput.focus();
                    return;
                }
                arrayContainer.dataset.field = key; // Устанавливаем data-field для будущего использования
            }

            if (!key) {
                console.error("Не удалось определить ключ массива.");
                return;
            }

            const itemDiv = document.createElement('div');
            itemDiv.className = 'metadata-array-item mb-2 simple-item-container'; // Для простого элемента
            itemDiv.innerHTML = `
                <div class="input-group">
                    <input type="text" class="form-control array-item-value" name="${key}[]" placeholder="Значение">
                    <button type="button" class="btn btn-outline-danger remove-array-item"><i class="bi bi-trash"></i></button>
                </div>
            `;
            actualItemsList.appendChild(itemDiv);
            itemDiv.querySelector('input.array-item-value').focus();
        }

        if (removeFieldButton) {
            if (removeFieldButton.classList.contains('remove-array')) {
                const key = removeFieldButton.dataset.key;
                if (confirm(`Вы уверены, что хотите удалить поле "${key}" и все его значения?`)) {
                    removeFieldButton.closest('.metadata-field').remove();
                }
            } else { // remove-field, remove-array-item, remove-object-item
                 removeFieldButton.closest('.metadata-field, .metadata-array-item, .metadata-object-item').remove();
            }
        }
    });

    // --- ОБРАБОТЧИК ОТПРАВКИ ФОРМЫ ---
    document.getElementById('metadataForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const form = this;
        const processedData = {};

        // 1. Обработка "одиночных" полей (не массивы, не новые простые поля)
        // Это включает простые текстовые поля и одиночные объекты {name, wikidata}
        form.querySelectorAll('#metadataFields > .metadata-field').forEach(fieldDiv => {
            const simpleInput = fieldDiv.querySelector(':scope > .input-group > input.form-control[name]');
            const singleObjectContainer = fieldDiv.querySelector(':scope > .single-wikidata-object[data-key]');
            const metadataObjectContainer = fieldDiv.querySelector(':scope > .metadata-object[data-field]'); // Для сложных объектов

            if (simpleInput && !simpleInput.closest('.new-simple-field-container')) { // Обычное простое поле
                 const key = simpleInput.name;
                 if (key !== 'csrfmiddlewaretoken' && !key.endsWith('[]') && !key.includes('[')) {
                    processedData[key] = simpleInput.value.trim();
                }
            } else if (singleObjectContainer) { // Одиночный объект {name, wikidata}
                const key = singleObjectContainer.dataset.key;
                const nameInput = singleObjectContainer.querySelector('.item-name-input');
                const wikidataInput = singleObjectContainer.querySelector('.item-wikidata-input');
                if (key && nameInput) {
                    // Сохраняем только значение, без преобразования в объект с name и wikidata
                    processedData[key] = nameInput.value.trim();
                }
            } else if (metadataObjectContainer) { // Стандартный объект (возможно, вложенный)
                const objectKey = metadataObjectContainer.dataset.field;
                if (objectKey) {
                    processedData[objectKey] = {};
                    // Собираем данные из полей объекта
                    metadataObjectContainer.querySelectorAll('.metadata-object-item, .metadata-nested-content .input-group').forEach(item => {
                        const input = item.querySelector('input.form-control[name]');
                        if (input && input.name.startsWith(`${objectKey}[`)) {
                            const nameParts = input.name.substring(objectKey.length + 1, input.name.length -1).split('][');
                            let currentLevel = processedData[objectKey];
                            for (let i = 0; i < nameParts.length -1; i++) {
                                if (!currentLevel[nameParts[i]]) {
                                    currentLevel[nameParts[i]] = {};
                                }
                                currentLevel = currentLevel[nameParts[i]];
                            }
                            currentLevel[nameParts[nameParts.length-1]] = input.value.trim();
                        }
                    });
                }
            }
        });

        // 2. Обработка новых простых полей
        form.querySelectorAll('.new-simple-field-container').forEach(container => {
            const keyInput = container.querySelector('.new-field-key');
            const valueInput = container.querySelector('.new-field-value');
            if (keyInput && valueInput && keyInput.value.trim()) {
                processedData[keyInput.value.trim()] = valueInput.value.trim();
            }
        });

        // 3. Обработка массивов (существующих и новых)
        form.querySelectorAll('.metadata-array').forEach(arrayDiv => {
            let arrayKey = arrayDiv.dataset.field;
            if (arrayDiv.closest('.new-array-container')) { // Новый массив
                const newKeyInput = arrayDiv.querySelector('.new-array-key-input');
                if (newKeyInput && newKeyInput.value.trim()) {
                    arrayKey = newKeyInput.value.trim();
                } else { // Если ключ для нового массива не введен, пропускаем его
                    return;
                }
            }

            if (!arrayKey) {
                 const label = arrayDiv.querySelector(':scope > .d-flex > .form-label');
                 if (label) arrayKey = label.textContent.trim();
            }
            if (!arrayKey) return;

            processedData[arrayKey] = [];
            arrayDiv.querySelectorAll('.actual-items-list > .metadata-array-item').forEach(itemDiv => {
                if (itemDiv.classList.contains('wikidata-item-container')) {
                    const nameInput = itemDiv.querySelector('.item-name-input');
                    if (nameInput && nameInput.value.trim()) {
                        // Сохраняем только значение, без преобразования в объект с name и wikidata
                        processedData[arrayKey].push(nameInput.value.trim());
                    }
                } else if (itemDiv.classList.contains('simple-item-container')) {
                    const valueInput = itemDiv.querySelector('.array-item-value');
                    if (valueInput && valueInput.value.trim()) {
                        processedData[arrayKey].push(valueInput.value.trim());
                    }
                }
            });
        });

        console.log('Processed data:', JSON.stringify(processedData, null, 2));

        let hiddenField = form.querySelector('input[name="processed_metadata"]');
        if (!hiddenField) {
            hiddenField = document.createElement('input');
            hiddenField.type = 'hidden';
            hiddenField.name = 'processed_metadata';
            form.appendChild(hiddenField);
        }
        hiddenField.value = JSON.stringify(processedData);

        form.submit();
    });

    // --- WIKIDATA ПОИСК И СВЯЗЫВАНИЕ ---
    const wikidataSearchForm = document.getElementById('wikidataSearchForm');
    if (wikidataSearchForm) {
        wikidataSearchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const query = document.getElementById('wikidataSearchQuery').value.trim();
            if (!query) {
                showAlert('Пожалуйста, введите поисковый запрос', 'warning');
                return;
            }
            
            // Проверяем, выбрано ли поле
            const selectedMetadata = getSelectedMetadataField();
            if (!selectedMetadata.fieldKey || !selectedMetadata.fieldValue) {
                showAlert('Пожалуйста, сначала выберите поле метаданных и его значение', 'warning');
                return;
            }
            
            // Показываем индикатор загрузки в контейнере результатов
            const resultsContainer = document.getElementById('wikidataSearchResults');
            resultsContainer.innerHTML = '<div class="text-center p-3"><div class="spinner-border text-primary" role="status"></div></div>';
            
            // Выполняем поиск
            searchWikidata(query);
        });
    }


    function searchWikidata(query) {
        const resultsContainer = document.getElementById('wikidataSearchResults');
        resultsContainer.innerHTML = '<div class="text-center p-3"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Загрузка...</span></div></div>';

        fetch(`/enhancer/api/wikidata/search/?query=${encodeURIComponent(query)}`)
            .then(response => {
                if (!response.ok) throw new Error(`Ошибка сети: ${response.statusText}`);
                return response.json();
            })
            .then(data => {
                if (data.results && data.results.length > 0) {
                    let html = '<div class="list-group">';
                    data.results.forEach(item => {
                        const entityNameSafe = (item.label || item.id).replace(/"/g, '"');
                        html += `
                            <div class="list-group-item list-group-item-action">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1 wikidata-entity-link" data-qid="${item.id}" style="cursor: pointer;">${item.label || item.id}</h6>
                                    <small>
                                        <a href="https://www.wikidata.org/wiki/${item.id}" target="_blank" class="btn btn-sm btn-outline-primary py-0 px-1" title="Открыть на Wikidata">
                                            <i class="bi bi-box-arrow-up-right"></i> ${item.id}
                                        </a>
                                    </small>
                                </div>
                                ${item.description ? `<p class="mb-1 small text-muted">${item.description}</p>` : ''}
                                <div class="d-flex justify-content-end mt-2">
                                    <button type="button" class="btn btn-sm btn-success link-entity-to-doc-btn"
                                            data-entity-id="${item.id}"
                                            data-entity-name="${entityNameSafe}">
                                        <i class="bi bi-link-45deg"></i> Связать с документом
                                    </button>
                                </div>
                            </div>`;
                    });
                    html += '</div>';
                    resultsContainer.innerHTML = html;
                } else {
                    resultsContainer.innerHTML = '<div class="alert alert-info">По вашему запросу ничего не найдено.</div>';
                }
            })
            .catch(error => {
                resultsContainer.innerHTML = `<div class="alert alert-danger">Ошибка поиска: ${error.message}</div>`;
            });
    }

    document.getElementById('wikidataSearchResults').addEventListener('click', function(e) {
        const linkToDocBtn = e.target.closest('.link-entity-to-doc-btn');
        const entityLink = e.target.closest('.wikidata-entity-link');

        if (linkToDocBtn) {
            const entityId = linkToDocBtn.dataset.entityId;
            const entityName = linkToDocBtn.dataset.entityName;
            
            // Получаем выбранный элемент метаданных
            const selectedMetadata = getSelectedMetadataField();
            
            // Проверяем, что поле и значение выбраны
            if (!selectedMetadata.fieldKey) {
                showAlert('Необходимо выбрать поле метаданных перед связыванием с Wikidata', 'danger');
                return;
            }
            
            if (!selectedMetadata.fieldValue) {
                showAlert('Необходимо выбрать значение для выбранного поля', 'danger');
                return;
            }
            
            // Показываем индикатор загрузки
            document.getElementById('entity-linking-indicator').style.display = 'block';
            
            // Создаем блокирующий оверлей
            const overlay = document.createElement('div');
            overlay.id = 'linking-overlay';
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            overlay.style.zIndex = '9999';
            overlay.style.display = 'flex';
            overlay.style.justifyContent = 'center';
            overlay.style.alignItems = 'center';
            
            const message = document.createElement('div');
            message.style.backgroundColor = 'white';
            message.style.padding = '20px';
            message.style.borderRadius = '5px';
            message.style.textAlign = 'center';
            message.innerHTML = '<div class="spinner-border text-primary me-2" role="status"></div> Связывание сущности...';
            
            overlay.appendChild(message);
            document.body.appendChild(overlay);
            
            // Для связывания с документом используем выбранные метаданные
            linkEntityToDocument({
                entity_id: entityId,
                entity_name: entityName,
                category: selectedMetadata.category || 'keywords',
                field_key: selectedMetadata.fieldKey,
                field_value: selectedMetadata.fieldValue
            });
        }
        
        if (entityLink) {
            e.preventDefault();
            const qid = entityLink.dataset.qid;
            if (qid) {
                showEntityInfo(qid, '#wikidata-entity-details');
                document.getElementById('wikidata-entity-details-card').style.display = 'block';
                document.getElementById('wikidata-entity-details-card').scrollIntoView({behavior: 'smooth'});
            }
        }
    });


    const updateWikidataBtn = document.getElementById('updateWikidataBtn');
    if (updateWikidataBtn) {
        updateWikidataBtn.addEventListener('click', function() {
            const documentId = this.dataset.documentId;
            updateWikidataLinks(documentId);
        });
    }

    const refreshDescriptionsBtn = document.getElementById('refreshDescriptionsBtn');
    if (refreshDescriptionsBtn) {
        refreshDescriptionsBtn.addEventListener('click', function() {
            const documentId = this.dataset.documentId;
            refreshEntityDescriptions(documentId);
        });
    }

    function updateWikidataLinks(documentId) {
        const indicator = document.getElementById('entity-linking-indicator');
        const container = document.getElementById('wikidata-entities-container');

        if (indicator) indicator.style.display = 'block';

        // Возвращаем Promise для поддержки .then()
        return new Promise((resolve, reject) => {
            fetch(`/enhancer/api/document/${documentId}/wikidata/update/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value,
                    'Accept': 'application/json'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка при обновлении связей: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Получен ответ:', data);
                    if (container) {
                        if (data.html_fragment) {
                            container.innerHTML = data.html_fragment;
                        } else {
                            container.innerHTML = '<div class="alert alert-warning">Не удалось загрузить сущности.</div>';
                        }
                    }
                    
                    // Показываем сообщение об успехе с количеством новых связей
                    const message = data.message || `Обновлено ${data.stats?.new || 0} связей с Wikidata`;
                    showAlert(message, 'success');
                    
                    // Вызываем функцию добавления кнопок массового удаления
                    setTimeout(addBulkUnlinkButtons, 100);
                    
                    // Разрешаем Promise с полученными данными
                    resolve(data);
                })
                .catch(error => {
                    console.error('Ошибка при обновлении связей:', error);
                    
                    // Показываем сообщение об ошибке в контейнере
                    if (container) {
                        container.innerHTML = `<div class="alert alert-danger">Ошибка: ${error.message}</div>`;
                    }
                    
                    // Показываем всплывающее уведомление
                    showAlert('Ошибка при обновлении связей: ' + error.message, 'danger');
                    
                    // Отклоняем Promise с ошибкой
                    reject(error);
                })
                .finally(() => {
                    // Скрываем индикатор загрузки в любом случае
                    if (indicator) indicator.style.display = 'none';
                });
        });
    }

    function refreshEntityDescriptions(documentId) {
        const indicator = document.getElementById('entity-linking-indicator');
        const container = document.getElementById('wikidata-entities-container');

        if (indicator) indicator.style.display = 'block';
        
        // Создаем блокирующий оверлей
        const overlay = document.createElement('div');
        overlay.id = 'refreshing-overlay';
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
        overlay.style.zIndex = '9999';
        overlay.style.display = 'flex';
        overlay.style.justifyContent = 'center';
        overlay.style.alignItems = 'center';
        
        const message = document.createElement('div');
        message.style.backgroundColor = 'white';
        message.style.padding = '20px';
        message.style.borderRadius = '5px';
        message.style.textAlign = 'center';
        message.innerHTML = '<div class="spinner-border text-primary me-2" role="status"></div> Обновление описаний сущностей...<br><small class="text-muted">Это может занять некоторое время</small>';
        
        overlay.appendChild(message);
        document.body.appendChild(overlay);

        fetch(`/enhancer/api/document/${documentId}/wikidata/refresh_descriptions/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Ошибка при обновлении описаний');
            }
            return response.json();
        })
        .then(data => {
            // Удаляем оверлей
            const overlay = document.getElementById('refreshing-overlay');
            if (overlay) {
                document.body.removeChild(overlay);
            }
            
            if (container) container.innerHTML = data.html_fragment || '<div class="alert alert-warning">Не удалось загрузить сущности.</div>';
            
            // Показываем сообщение об успехе
            showAlert(data.message || 'Описания сущностей обновлены');
            
            // Вызываем функцию добавления кнопок массового удаления после обновления
            setTimeout(addBulkUnlinkButtons, 100);
        })
        .catch(error => {
            // Удаляем оверлей
            const overlay = document.getElementById('refreshing-overlay');
            if (overlay) {
                document.body.removeChild(overlay);
            }
            
            if (container) container.innerHTML = `<div class="alert alert-danger">Ошибка: ${error.message}</div>`;
            
            // Показываем сообщение об ошибке
            showAlert('Ошибка при обновлении описаний: ' + error.message, 'danger');
        })
        .finally(() => {
            if (indicator) indicator.style.display = 'none';
        });
    }

    function linkEntityToDocument(data) {
        const documentId = document.getElementById('updateWikidataBtn').dataset.documentId;
        const indicator = document.getElementById('entity-linking-indicator');
        if(indicator) indicator.style.display = 'block';

        fetch(`/enhancer/api/document/${documentId}/wikidata/link/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            // Удаляем оверлей
            const overlay = document.getElementById('linking-overlay');
            if (overlay) {
                document.body.removeChild(overlay);
            }
            
            if(result.success) {
                // Очищаем результаты поиска
                document.getElementById('wikidataSearchQuery').value = '';
                document.getElementById('wikidataSearchResults').innerHTML = '';
                
                // Сбрасываем выбранное поле
                document.getElementById('metadataFieldKey').value = '';
                document.getElementById('metadataFieldCategory').value = '';
                document.getElementById('simpleFieldValueContainer').style.display = 'none';
                document.getElementById('arrayFieldValueContainer').style.display = 'none';
                updateSelectedFieldIndicator();
                
                // Обновляем список связанных сущностей
                // Сначала показываем уведомление об успехе
                showAlert(result.message || 'Сущность успешно связана с документом');
                
                // Затем обновляем список сущностей
                updateWikidataLinks(documentId)
                    .catch(error => {
                        // Обрабатываем ошибку при обновлении списка, если она возникает
                        console.error('Ошибка при обновлении списка сущностей:', error);
                    });
            } else {
                // Показываем сообщение об ошибке
                showAlert(result.error || result.message || 'Произошла ошибка при связывании сущности', 'danger');
            }
        })
        .catch(error => {
            // Удаляем оверлей
            const overlay = document.getElementById('linking-overlay');
            if (overlay) {
                document.body.removeChild(overlay);
            }
            
            // Показываем сообщение об ошибке
            showAlert('Критическая ошибка: ' + error.message, 'danger');
        })
        .finally(() => {
            if(indicator) indicator.style.display = 'none';
        });
    }

    document.getElementById('wikidata-entities-container').addEventListener('click', function(e){
        const unlinkBtn = e.target.closest('.unlink-entity-btn');
        const bulkUnlinkBtn = e.target.closest('.bulk-unlink-btn');
        const entityLink = e.target.closest('.wikidata-entity-link');

        if (unlinkBtn) {
            e.preventDefault();
            const entityId = unlinkBtn.dataset.entityId;
            const relationId = unlinkBtn.dataset.relationId;
            const category = unlinkBtn.dataset.category;
            const fieldKey = unlinkBtn.dataset.fieldKey;
            const fieldValue = unlinkBtn.dataset.fieldValue;
            const documentId = document.getElementById('updateWikidataBtn').dataset.documentId;
            
            unlinkEntityFromDocument(documentId, entityId, relationId, category, fieldKey, fieldValue, unlinkBtn);
        }
        
        if (bulkUnlinkBtn) {
            e.preventDefault();
            const entityId = bulkUnlinkBtn.dataset.entityId;
            const category = bulkUnlinkBtn.dataset.category;
            const documentId = document.getElementById('updateWikidataBtn').dataset.documentId;
            
            unlinkAllEntityRelations(documentId, entityId, category);
        }

        if (entityLink) {
            e.preventDefault();
            const qid = entityLink.dataset.qid;
            if (qid) {
                showEntityInfo(qid, '#wikidata-entity-details');
                document.getElementById('wikidata-entity-details-card').style.display = 'block';
                document.getElementById('wikidata-entity-details-card').scrollIntoView({behavior: 'smooth'});
            }
        }
    });

    function unlinkEntityFromDocument(documentId, entityId, relationId, category, fieldKey, fieldValue, buttonElement, bulkMode = false) {
        // Показываем модальное окно подтверждения с использованием Bootstrap
        let confirmMessage = 'Вы действительно хотите удалить связь с этой сущностью?';
        if (bulkMode) {
            confirmMessage = 'Вы действительно хотите удалить все связи с этой сущностью в выбранной категории?';
        }
        
        if (!confirm(confirmMessage)) {
            return;
        }
        
        const indicator = document.getElementById('entity-linking-indicator');
        if(indicator) indicator.style.display = 'block';
        
        // Создаем блокирующий оверлей
        const overlay = document.createElement('div');
        overlay.id = 'unlinking-overlay';
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
        overlay.style.zIndex = '9999';
        overlay.style.display = 'flex';
        overlay.style.justifyContent = 'center';
        overlay.style.alignItems = 'center';
        
        const message = document.createElement('div');
        message.style.backgroundColor = 'white';
        message.style.padding = '20px';
        message.style.borderRadius = '5px';
        message.style.textAlign = 'center';
        message.innerHTML = '<div class="spinner-border text-primary me-2" role="status"></div> Удаление связи...';
        
        overlay.appendChild(message);
        document.body.appendChild(overlay);

        fetch(`/enhancer/api/document/${documentId}/wikidata/unlink/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value
            },
            body: JSON.stringify({
                entity_id: entityId,
                relation_id: relationId,
                category: category,
                field_key: fieldKey,
                field_value: fieldValue,
                bulk_mode: bulkMode
            })
        })
        .then(response => response.json())
        .then(data => {
            // Удаляем оверлей
            const overlay = document.getElementById('unlinking-overlay');
            if (overlay) {
                document.body.removeChild(overlay);
            }
            
            if (data.success) {
                if (bulkMode) {
                    // Если это массовое удаление, обновляем весь контейнер сущностей
                    updateWikidataLinks(documentId);
                } else {
                    // Если это одиночное удаление, анимируем удаление элемента
                    const listItem = buttonElement.closest('.list-group-item');
                    if (listItem) {
                        listItem.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
                        listItem.style.opacity = '0';
                        listItem.style.transform = 'translateX(20px)';
                        setTimeout(() => {
                            listItem.remove();
                            // Обновить счетчик, если есть
                            const tabId = `tab-${category}`; // Предполагая, что id таба так формируется
                            const tabElement = document.getElementById(tabId);
                            if(tabElement){
                                const countSpan = tabElement.querySelector('.badge');
                                if(countSpan){
                                    let currentCount = parseInt(countSpan.textContent);
                                    if(!isNaN(currentCount) && currentCount > 0){
                                        // Если удалили одну связь или больше (bulkMode), уменьшаем счетчик
                                        let decrementAmount = data.affected_count || 1;
                                        let newCount = Math.max(0, currentCount - decrementAmount);
                                        countSpan.textContent = newCount;
                                        if(newCount === 0){
                                            // Если категория стала пустой, показываем сообщение об этом
                                            const tabPane = document.getElementById(`pane-${category}`);
                                            if(tabPane) tabPane.innerHTML = '<p class="text-muted p-3">В этой категории нет связанных сущностей.</p>';
                                            if(tabElement.classList.contains('active')){
                                                // Если активный таб стал пустым, переключиться на другой, если есть
                                                const firstAvailableTab = document.querySelector('#wikidata-tabs .nav-link:not([hidden])');
                                                if(firstAvailableTab) new bootstrap.Tab(firstAvailableTab).show();
                                            }
                                        }
                                    }
                                }
                            }
                        }, 300);
                    }
                }
                
                // Показываем сообщение об успехе
                showAlert(data.message || 'Связь успешно удалена');
            } else {
                // Показываем сообщение об ошибке
                showAlert(data.error || data.message || 'Произошла ошибка при удалении связи', 'danger');
            }
        })
        .catch(error => {
            // Удаляем оверлей
            const overlay = document.getElementById('unlinking-overlay');
            if (overlay) {
                document.body.removeChild(overlay);
            }
            
            // Показываем сообщение об ошибке
            showAlert('Критическая ошибка при отвязывании: ' + error.message, 'danger');
        })
        .finally(() => {
            if(indicator) indicator.style.display = 'none';
        });
    }

    // Добавляем функцию для массового удаления всех связей сущности в категории
    function unlinkAllEntityRelations(documentId, entityId, category) {
        unlinkEntityFromDocument(documentId, entityId, null, category, null, null, null, true);
    }

    // Добавляем кнопки для массового удаления в каждую категорию
    function addBulkUnlinkButtons() {
        const tabs = document.querySelectorAll('#wikidata-tabs .nav-link');
        tabs.forEach(tab => {
            const category = tab.dataset.category;
            if (!category) return;
            
            const pane = document.getElementById(`pane-${category}`);
            if (!pane) return;
            
            // Группируем сущности по QID
            const entities = {};
            pane.querySelectorAll('.list-group-item').forEach(item => {
                const unlinkBtn = item.querySelector('.unlink-entity-btn');
                if (unlinkBtn) {
                    const entityId = unlinkBtn.dataset.entityId;
                    const entityName = item.querySelector('.wikidata-entity-link').textContent;
                    
                    if (!entities[entityId]) {
                        entities[entityId] = {
                            name: entityName,
                            count: 0
                        };
                    }
                    entities[entityId].count++;
                }
            });
            
            // Если есть сущности с несколькими связями, добавляем кнопки для массового удаления
            Object.keys(entities).forEach(entityId => {
                if (entities[entityId].count > 1) {
                    const entityItems = pane.querySelectorAll(`.unlink-entity-btn[data-entity-id="${entityId}"]`);
                    const firstItem = entityItems[0].closest('.list-group-item');
                    
                    // Проверяем, нет ли уже кнопки массового удаления
                    if (!firstItem.querySelector('.bulk-unlink-btn')) {
                        const bulkBtn = document.createElement('button');
                        bulkBtn.className = 'btn btn-sm btn-outline-danger bulk-unlink-btn ms-2';
                        bulkBtn.title = `Удалить все связи с ${entities[entityId].name} (${entities[entityId].count})`;
                        bulkBtn.innerHTML = '<i class="bi bi-trash"></i> Удалить все';
                        bulkBtn.dataset.entityId = entityId;
                        bulkBtn.dataset.category = category;
                        
                        // Добавляем кнопку в первый элемент
                        const actionGroup = firstItem.querySelector('.d-flex.justify-content-end');
                        if (actionGroup) {
                            actionGroup.appendChild(bulkBtn);
                        }
                    }
                }
            });
        });
    }

    // Вызываем функцию добавления кнопок при загрузке страницы и после обновления связей
    document.addEventListener('DOMContentLoaded', function() {
        addBulkUnlinkButtons();
    });

    // Обновляем функцию updateWikidataLinks, чтобы вызывать addBulkUnlinkButtons после обновления
    const originalUpdateWikidataLinks = updateWikidataLinks;
    updateWikidataLinks = function(documentId) {
        return originalUpdateWikidataLinks(documentId).then(() => {
            setTimeout(addBulkUnlinkButtons, 100); // Добавляем небольшую задержку
            return Promise.resolve();
        });
    };

    // Обновленная функция для получения выбранного поля метаданных
    function getSelectedMetadataField() {
        // Получаем значения из интерфейса выбора поля метаданных
        const category = document.getElementById('metadataFieldCategory').value;
        const fieldKey = document.getElementById('metadataFieldKey').value;
        
        // Получаем значение в зависимости от типа поля
        let fieldValue = '';
        const selectedOption = document.getElementById('metadataFieldKey').selectedOptions[0];
        if (selectedOption) {
            const fieldType = selectedOption.dataset.type;
            if (fieldType === 'array') {
                fieldValue = document.getElementById('metadataFieldArrayValue').value;
            } else {
                fieldValue = document.getElementById('metadataFieldSimpleValue').value;
            }
        }
        
        return {
            category: category, 
            fieldKey: fieldKey,
            fieldValue: fieldValue
        };
    }

    // Обновляем индикатор выбранного поля при изменении значений
    document.getElementById('metadataFieldArrayValue').addEventListener('change', function() {
        updateSelectedFieldIndicator();
    });

    function updateSelectedFieldIndicator() {
        const selectedMetadata = getSelectedMetadataField();
        const indicator = document.getElementById('selectedFieldIndicator');
        
        if (selectedMetadata.fieldKey && selectedMetadata.fieldValue) {
            indicator.style.display = 'inline-block';
            indicator.textContent = `${selectedMetadata.fieldKey}: ${selectedMetadata.fieldValue}`;
            
            // Добавляем визуальное выделение выбранного поля
            // Подсвечиваем селект поля
            document.getElementById('metadataFieldKey').classList.add('border-success');
            
            // Подсвечиваем активное значение (в зависимости от типа поля)
            const selectedOption = document.getElementById('metadataFieldKey').selectedOptions[0];
            if (selectedOption) {
                const fieldType = selectedOption.dataset.type;
                if (fieldType === 'array') {
                    document.getElementById('metadataFieldArrayValue').classList.add('border-success');
                    document.getElementById('metadataFieldSimpleValue').classList.remove('border-success');
                } else {
                    document.getElementById('metadataFieldSimpleValue').classList.add('border-success');
                    document.getElementById('metadataFieldArrayValue').classList.remove('border-success');
                }
            }
        } else {
            indicator.style.display = 'none';
            
            // Убираем подсветку полей
            document.getElementById('metadataFieldKey').classList.remove('border-success');
            document.getElementById('metadataFieldSimpleValue').classList.remove('border-success');
            document.getElementById('metadataFieldArrayValue').classList.remove('border-success');
        }
    }

    // Обработчик для изменения выбранного поля метаданных
    document.getElementById('metadataFieldKey').addEventListener('change', function() {
        const fieldKey = this.value;
        const simpleContainer = document.getElementById('simpleFieldValueContainer');
        const arrayContainer = document.getElementById('arrayFieldValueContainer');
        
        // Очищаем контейнеры
        simpleContainer.style.display = 'none';
        arrayContainer.style.display = 'none';
        document.getElementById('metadataFieldCategory').value = '';
        
        if (!fieldKey) return;
        
        // Получаем тип выбранного поля
        const selectedOption = this.selectedOptions[0];
        const fieldType = selectedOption.dataset.type;
        
        // Автоматически определяем категорию по ключу
        const categoryMapping = {
            'keywords': 'keywords',
            'subject': 'subject',
            'creator': 'creator',
            'authors': 'creator',
            'language': 'document_language',
            'publisher': 'organizations',
            'contributor': 'contributor'
        };
        
        // Приводим ключ к нижнему регистру для сравнения
        const lowerKey = fieldKey.toLowerCase();
        
        // Устанавливаем категорию
        let category = '';
        for (const key in categoryMapping) {
            if (lowerKey === key || lowerKey.includes(key)) {
                category = categoryMapping[key];
                break;
            }
        }
        
        // Если категория не найдена, используем ключ как категорию
        if (!category) {
            category = lowerKey;
        }
        
        document.getElementById('metadataFieldCategory').value = category;
        
        // Обработка в зависимости от типа поля
        if (fieldType === 'array') {
            // Если это массив, загружаем его значения в селект
            arrayContainer.style.display = 'block';
            const arraySelect = document.getElementById('metadataFieldArrayValue');
            arraySelect.innerHTML = '<option value="" selected>Выберите значение</option>';
            
            // Получаем значения массива из метаданных
            const metadataObj = JSON.parse('{{ metadata|escapejs }}');
            if (metadataObj && metadataObj[fieldKey] && Array.isArray(metadataObj[fieldKey])) {
                metadataObj[fieldKey].forEach(item => {
                    let itemValue = '';
                    if (typeof item === 'string') {
                        itemValue = item;
                    } else if (typeof item === 'object' && item !== null) {
                        // Если это объект, пытаемся получить значение 'name'
                        itemValue = item.name || JSON.stringify(item);
                    } else {
                        itemValue = String(item);
                    }
                    
                    const option = document.createElement('option');
                    option.value = itemValue;
                    option.text = itemValue;
                    arraySelect.appendChild(option);
                });
            }
        } else {
            // Если это простое поле, показываем инпут с его значением
            simpleContainer.style.display = 'block';
            
            // Получаем значение из метаданных
            const metadataObj = JSON.parse('{{ metadata|escapejs }}');
            let fieldValue = '';
            
            if (metadataObj && metadataObj[fieldKey] !== undefined) {
                if (typeof metadataObj[fieldKey] === 'string') {
                    fieldValue = metadataObj[fieldKey];
                } else if (typeof metadataObj[fieldKey] === 'object' && metadataObj[fieldKey] !== null) {
                    // Если это объект, пытаемся получить значение 'name'
                    fieldValue = metadataObj[fieldKey].name || JSON.stringify(metadataObj[fieldKey]);
                } else {
                    fieldValue = String(metadataObj[fieldKey]);
                }
            }
            
            document.getElementById('metadataFieldSimpleValue').value = fieldValue;
        }
        
        // В конце функции обновляем индикатор
        updateSelectedFieldIndicator();
    });

    function showEntityInfo(qid, containerSelector) {
        const container = document.querySelector(containerSelector);
        if (!container) return;
        
        container.innerHTML = '<div class="text-center p-3"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Загрузка...</span></div></div>';

        fetch(`/enhancer/wikidata/entity/${qid}/info/`)
            .then(response => {
                if (!response.ok) throw new Error(`Ошибка сети: ${response.statusText}`);
                return response.json();
            })
            .then(data => {
                let html = `<h5 class="card-title">
                    ${data.label_ru || data.label_en || data.id}
                    <a href="https://www.wikidata.org/wiki/${data.id}" class="ms-2 text-decoration-none" target="_blank" title="Открыть на Wikidata">
                        <small class="text-muted">${data.id}</small> <i class="bi bi-box-arrow-up-right"></i>
                    </a>
                </h5>`;
                
                if (data.description_ru || data.description_en) {
                    html += `<p class="card-subtitle mb-3 text-muted">${data.description_ru || data.description_en}</p>`;
                }
                
                // Если есть свойства, отображаем их
                if (data.properties && Object.keys(data.properties).length > 0) {
                    html += '<hr><h6>Свойства:</h6>';
                    html += '<div class="table-responsive"><table class="table table-sm table-striped">';
                    html += '<thead><tr><th>Свойство</th><th>Значение</th></tr></thead><tbody>';
                    
                    for (const propId in data.properties) {
                        const propData = data.properties[propId];
                        const propLabel = propData.label || propId;
                        
                        html += `<tr><td>${propLabel}</td><td>`;
                        
                        if (Array.isArray(propData.values)) {
                            propData.values.forEach((value, index) => {
                                if (index > 0) html += ', ';
                                
                                if (value.qid) {
                                    html += `<a href="#" class="wikidata-entity-link" data-qid="${value.qid}">${value.value}</a>`;
                                } else {
                                    html += value.value;
                                }
                            });
                        } else if (propData.value) {
                            html += propData.value;
                        }
                        
                        html += '</td></tr>';
                    }
                    
                    html += '</tbody></table></div>';
                } else {
                    html += '<div class="alert alert-light mt-3">Нет доступных свойств для этой сущности.</div>';
                }
                
                container.innerHTML = html;
                
                // Добавляем обработчики для внутренних ссылок на сущности
                container.querySelectorAll('.wikidata-entity-link').forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const linkedQid = this.dataset.qid;
                        if (linkedQid) {
                            showEntityInfo(linkedQid, containerSelector);
                        }
                    });
                });
            })
            .catch(error => {
                container.innerHTML = `<div class="alert alert-danger">Ошибка загрузки информации: ${error.message}</div>`;
            });
    }

    // Обработчик для кнопки экспорта документа
    const exportBtn = document.getElementById('exportDocumentBtn');
    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            const documentId = this.dataset.documentId;
            
            // Настраиваем форму экспорта
            const exportForm = document.getElementById('exportDocumentForm');
            if (exportForm) {
                // Используем Django URL шаблон
                exportForm.action = "{% url 'enhancer:document_export' 0 %}".replace('0', documentId);
                
                // Показываем модальное окно
                const exportModal = new bootstrap.Modal(document.getElementById('exportDocumentModal'));
                exportModal.show();
            } else {
                console.error('Форма экспорта не найдена!');
            }
        });
    }
    
    // Обработчик отправки формы экспорта
    const exportForm = document.getElementById('exportDocumentForm');
    if (exportForm) {
        exportForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Получаем выбранные параметры экспорта
            const metadataFormat = document.querySelector('input[name="metadata_format"]:checked').value;
            const includeWikidata = document.getElementById('includeWikidata').checked ? 1 : 0;
            const exportType = document.querySelector('input[name="export_type"]:checked').value;
            
            // Создаем URL для экспорта с параметрами
            const url = this.action + `?format=${metadataFormat}&include_wikidata=${includeWikidata}&export_type=${exportType}`;
            
            // Закрываем модальное окно
            const modal = bootstrap.Modal.getInstance(document.getElementById('exportDocumentModal'));
            if (modal) {
                modal.hide();
            }
            
            // Перенаправляем пользователя для скачивания
            window.location.href = url;
        });
    }

});
</script>
{% endblock %}
